<!DOCTYPE html>
<html>
<head>
  <title>Absensi QR Scanner</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; background: #f7f7f7; }
    h2 { margin-bottom: 10px; }
    #scanner { width: 100%; max-width: 400px; margin: auto; display: none; }
    #status { font-size: 1.5em; margin-top: 20px; font-weight: bold; }
    button, select {
      padding: 12px 24px;
      font-size: 1em;
      margin-top: 10px;
      border-radius: 6px;
      border: none;
    }
    button { background: #2c7be5; color: white; cursor: pointer; }
    button:hover { background: #1a5dc3; }
  </style>
</head>
<body>
  <h2>Scan QR untuk Absen</h2>
  <select id="camera-select" style="display:none;"></select><br>
  <button onclick="initApp()">Mulai Scanner</button>
  <div id="scanner"></div>
  <div id="status"></div>
  <audio id="beep" src="https://www.soundjay.com/buttons/sounds/beep-07.mp3"></audio>

  <script>
    const urlAPI = "https://script.google.com/macros/s/AKfycbwVUv1ij8NQFbkrMWv3yS3kFelqkthuQwkagUkdgDE2y-Cjl9rnP5pvWC7OToOtZPd3/exec";
    const statusDiv = document.getElementById("status");
    const beep = document.getElementById("beep");
    const cameraSelect = document.getElementById("camera-select");
    let scanner;

    function showStatus(pesan, warna) {
      statusDiv.textContent = pesan;
      statusDiv.style.color = warna;
    }

    function resetStatus() {
      setTimeout(() => {
        showStatus("", "black");
        startScanner(cameraSelect.value);
      }, 2000);
    }

    function startScanner(cameraId) {
      scanner.start(
        cameraId,
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          scanner.stop().then(() => {
            fetch(urlAPI + "?token=" + encodeURIComponent(qrCodeMessage))
              .then(res => res.json())
              .then(data => {
                if (data.status === "success") {
                  beep.play().catch(e => console.log("Beep error:", e));
                  showStatus("✅ Selamat datang, " + data.nama, "green");
                } else {
                  showStatus("❌ " + data.pesan, "red");
                }
                resetStatus();
              })
              .catch(err => {
                showStatus("⚠️ Gagal konek ke server", "orange");
                resetStatus();
              });
          });
        },
        errorMessage => {}
      );
    }

    function initApp() {
      document.querySelector("button").style.display = "none";
      document.getElementById("scanner").style.display = "block";
      cameraSelect.style.display = "inline";

      // Panaskan suara biar bisa dipakai
      beep.play().then(() => {
        beep.pause();
        beep.currentTime = 0;
      });

      scanner = new Html5Qrcode("scanner");
      Html5Qrcode.getCameras().then(devices => {
        cameraSelect.innerHTML = "";
        devices.forEach(d => {
          const opt = document.createElement("option");
          opt.value = d.id;
          opt.text = d.label || `Camera ${cameraSelect.length + 1}`;
          cameraSelect.appendChild(opt);
        });
        if (devices.length > 0) {
          startScanner(devices[0].id); // Start pertama pakai kamera pertama
        }
        cameraSelect.onchange = () => {
          scanner.stop().then(() => startScanner(cameraSelect.value));
        };
      });
    }
  </script>
</body>
</html>
