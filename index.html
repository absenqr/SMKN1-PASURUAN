<!DOCTYPE html>
<html>
<head>
  <title>Absensi QR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 0; padding: 20px; }
    #scanner { width: 100%; max-width: 400px; margin: auto; }
    #status { margin-top: 20px; font-size: 1.2em; }
    select { margin: 10px; padding: 5px; font-size: 1em; }
  </style>
</head>
<body>
  <h2>Scan QR untuk Absen</h2>

  <select id="cameraSelect"></select>
  <div id="scanner"></div>
  <div id="status">Menunggu scan...</div>

  <audio id="beep" preload="auto">
    <source src="https://www.soundjay.com/button/sounds/beep-07.mp3" type="audio/mpeg">
  </audio>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwVUv1ij8NQFbkrMWv3yS3kFelqkthuQwkagUkdgDE2y-Cjl9rnP5pvWC7OToOtZPd3/exec";
    const beep = document.getElementById("beep");
    const statusDiv = document.getElementById("status");
    const cameraSelect = document.getElementById("cameraSelect");

    let scanner = null;

    function showStatus(msg, color = "black") {
      statusDiv.textContent = msg;
      statusDiv.style.color = color;
    }

    async function startScanner(cameraId) {
      if (scanner) await scanner.stop();

      scanner = new Html5Qrcode("scanner");

      scanner.start(
        cameraId,
        { fps: 10, qrbox: 200 },
        qrMsg => {
          scanner.stop().then(() => {
            fetch(GAS_URL + "?token=" + encodeURIComponent(qrMsg))
              .then(res => res.json())
              .then(data => {
                if (data.status === "success") {
                  beep.play().catch(() => {});
                  showStatus("✅ Selamat datang, " + data.nama, "green");
                } else {
                  showStatus("❌ " + data.pesan, "red");
                }
              })
              .catch(() => {
                showStatus("⚠️ Gagal koneksi", "orange");
              })
              .finally(() => {
                setTimeout(() => {
                  showStatus("Menunggu scan...", "black");
                  startScanner(cameraId); // lanjut lagi
                }, 2000);
              });
          });
        },
        err => {}
      );
    }

    Html5Qrcode.getCameras().then(devices => {
      devices.forEach(cam => {
        const option = document.createElement("option");
        option.value = cam.id;
        option.textContent = cam.label || `Kamera ${cameraSelect.length + 1}`;
        cameraSelect.appendChild(option);
      });

      if (devices.length > 0) {
        cameraSelect.addEventListener("change", () => {
          startScanner(cameraSelect.value);
        });

        startScanner(devices[0].id); // default kamera pertama
      } else {
        showStatus("Tidak ada kamera ditemukan", "red");
      }
    });

    // Play audio permission
    document.body.addEventListener("click", () => beep.play().catch(() => {}), { once: true });
  </script>
</body>
</html>
