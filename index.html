<!DOCTYPE html>
<html>
<head>
  <title>Absensi QR Scanner</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; background: #f2f2f2; }
    #status { font-size: 1.5em; margin-top: 20px; font-weight: bold; }
    #scanner { width: 100%; max-width: 400px; margin: auto; }
    button { padding: 12px 24px; font-size: 1em; background: #2c7be5; color: white; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #1b5ec9; }
  </style>
</head>
<body>
  <h2>Scan QR untuk Absen</h2>
  <button onclick="initApp()">Mulai Scanner</button>
  <div id="scanner" style="display:none;"></div>
  <div id="status"></div>
  <audio id="beep" src="https://www.soundjay.com/buttons/sounds/beep-07.mp3"></audio>

  <script>
    const urlAPI = "https://script.google.com/macros/s/AKfycbwVUv1ij8NQFbkrMWv3yS3kFelqkthuQwkagUkdgDE2y-Cjl9rnP5pvWC7OToOtZPd3/exec";
    const statusDiv = document.getElementById("status");
    const beep = document.getElementById("beep");
    let scanner;

    function showStatus(pesan, warna) {
      statusDiv.textContent = pesan;
      statusDiv.style.color = warna;
    }

    function resetStatus() {
      setTimeout(() => {
        showStatus("", "black");
        startScanner();
      }, 2000);
    }

    function startScanner() {
      scanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          scanner.stop().then(() => {
            fetch(urlAPI + "?token=" + encodeURIComponent(qrCodeMessage))
              .then(res => res.json())
              .then(data => {
                if (data.status === "success") {
                  beep.play().catch(e => console.log("Beep error:", e));
                  showStatus("✅ Selamat datang, " + data.nama, "green");
                } else {
                  showStatus("❌ " + data.pesan, "red");
                }
                resetStatus();
              })
              .catch(err => {
                showStatus("⚠️ Gagal konek ke server", "orange");
                resetStatus();
              });
          });
        },
        errorMessage => {
          // QR error, no need to show
        }
      );
    }

    function initApp() {
      document.querySelector("button").style.display = "none";
      document.getElementById("scanner").style.display = "block";
      scanner = new Html5Qrcode("scanner");
      startScanner();
    }
  </script>
</body>
</html>
